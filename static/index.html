<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chicago Intel | Offline Ops</title>
  <link rel="stylesheet" href="/static/vendor/leaflet.css" />
  <script src="/static/vendor/leaflet.js"></script>
  <script src="/static/vendor/chart.js"></script>
  <style>
    :root {
      --bg: #050910;
      --panel: rgba(16, 24, 39, 0.85);
      --accent: #60a5fa;
      --accent-strong: #3b82f6;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: rgba(148, 163, 184, 0.15);
      --danger: #ef4444;
      --warn: #f59e0b;
      --success: #22c55e;
      --glass: rgba(15, 23, 42, 0.65);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI", system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    .bg-blur {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background: radial-gradient(900px 900px at 10% 20%, rgba(59,130,246,0.08), transparent),
                  radial-gradient(900px 900px at 80% 10%, rgba(14,165,233,0.08), transparent),
                  radial-gradient(1100px 1100px at 40% 80%, rgba(139,92,246,0.08), transparent);
    }
    .layout { position: relative; display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; z-index: 1; }
    .sidebar { background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(10,15,25,0.9)); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 22px 18px; gap: 20px; backdrop-filter: blur(8px); }
    .brand { font-weight: 800; letter-spacing: 0.1em; font-size: 18px; }
    .tag { color: var(--muted); font-size: 12px; }
    .nav button { width: 100%; padding: 12px; border: 1px solid var(--border); background: var(--glass); color: var(--muted); border-radius: 12px; cursor: pointer; font-weight: 700; text-align: left; transition: 0.15s ease; }
    .nav button:hover { border-color: var(--accent); color: var(--text); }
    .nav button.active { background: rgba(59,130,246,0.12); color: var(--accent); border-color: rgba(59,130,246,0.35); box-shadow: 0 10px 30px rgba(59,130,246,0.12); }
    header { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid var(--border); background: rgba(10,16,26,0.85); position: sticky; top: 0; z-index: 5; backdrop-filter: blur(10px); }
    main { padding: 24px 24px 40px; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 12px 50px rgba(0,0,0,0.25); }
    .kpi-label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .kpi-value { font-size: 28px; font-weight: 800; margin-top: 6px; }
    .grid { display: grid; gap: 16px; }
    .grid.two { grid-template-columns: 2fr 1fr; }
    .map { width: 100%; height: 520px; border-radius: 14px; overflow: hidden; }
    .section-title { font-size: 14px; color: var(--muted); margin-bottom: 8px; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase; }
    select { background: rgba(11,18,36,0.9); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .network-meta { display: flex; gap: 16px; font-size: 13px; color: var(--muted); flex-wrap: wrap; }
    .list { display: grid; gap: 10px; max-height: 540px; overflow-y: auto; padding-right: 4px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 12px; font-size: 13px; border: 1px solid var(--border); background: rgba(17,24,39,0.8); color: var(--text); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
    .status { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; color: var(--success); }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; }
    .trend-card { background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(14,165,233,0.12)); border: 1px solid rgba(59,130,246,0.3); }
    .top-type-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); }
    .bar { height: 6px; border-radius: 999px; background: rgba(59,130,246,0.25); overflow: hidden; margin-top: 4px; }
    .bar > div { height: 100%; background: linear-gradient(90deg, #38bdf8, #6366f1); }
    @media (max-width: 1080px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } header { position: sticky; } }
  </style>
</head>
<body>
  <div class="bg-blur"></div>
  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="brand">INTEL OPS</div>
        <div class="tag">Air-gapped | Offline-first</div>
      </div>
      <div class="nav">
        <button id="btn-dashboard" class="active" onclick="setView('dashboard')">Dashboard</button>
        <button id="btn-network" onclick="setView('network')">Network Analysis</button>
      </div>
      <div class="status"><span class="dot"></span>Offline ready</div>
    </aside>
    <div style="display:flex; flex-direction:column; min-height:100vh;">
      <header>
        <div>
          <div style="font-weight:700;">Operations Center</div>
          <div style="color:var(--muted); font-size:12px;">Chicago crime insights (local CSV)</div>
        </div>
        <div>
          <select id="crime-select" onchange="refreshView()">
            <option value="ALL">All Crimes</option>
            <option value="ROBBERY" selected>Robbery</option>
            <option value="MOTOR VEHICLE THEFT">Motor Vehicle Theft</option>
            <option value="BURGLARY">Burglary</option>
            <option value="WEAPONS VIOLATION">Weapons Violation</option>
          </select>
        </div>
      </header>

      <main>
        <div id="status-banner" style="display:none; margin-bottom:12px;">
          <div class="card" style="border-left:4px solid var(--warn); color:var(--text); font-size:13px;" id="status-text"></div>
        </div>
        <section id="view-dashboard">
          <div class="cards">
            <div class="card">
              <div class="kpi-label">Total Loaded</div>
              <div class="kpi-value" id="kpi-total">--</div>
              <div class="section-title" style="margin-top:6px;">Date Span</div>
              <div id="kpi-range" style="color:var(--muted); font-size:13px;">--</div>
            </div>
            <div class="card">
              <div class="kpi-label">Arrest Rate</div>
              <div class="kpi-value" id="kpi-arrest">--%</div>
              <div class="section-title" style="margin-top:6px;">Top Types</div>
              <div id="top-types" style="font-size:13px; color:var(--muted); display:grid; gap:6px;"></div>
            </div>
            <div class="card trend-card">
              <div class="kpi-label">Active Hotspots</div>
              <div class="kpi-value" id="kpi-hotspots">--</div>
              <div class="section-title" style="margin-top:6px;">Monthly Trend</div>
              <canvas id="chart-monthly" height="120"></canvas>
            </div>
          </div>

          <div class="grid two" style="margin-top:20px;">
            <div class="card">
              <div class="section-title">Hotspots</div>
              <div id="map-hotspots" class="map"></div>
            </div>
            <div class="grid" style="grid-template-rows: 1fr;">
              <div class="card" style="min-height:320px;">
                <div class="section-title">Hourly Pattern</div>
                <canvas id="chart-hourly" height="220"></canvas>
              </div>
              <div class="card">
                <div class="section-title">Pareto (Beat Concentration)</div>
                <div id="pareto" style="font-size:13px; color:var(--muted);">--</div>
              </div>
            </div>
          </div>
        </section>

        <section id="view-network" style="display:none;">
          <div class="card" style="margin-bottom:16px; border-left: 4px solid var(--accent);">
            <div style="font-weight:700; margin-bottom:6px;">Spatiotemporal Linkage</div>
            <div style="font-size:13px; color:var(--muted);">Incidents within <strong>0.5 miles</strong> and <strong>3 days</strong>.</div>
            <div class="network-meta" style="margin-top:10px;">
              <span id="net-nodes">Nodes: --</span>
              <span id="net-edges">Edges: --</span>
              <span id="net-components">Components: --</span>
            </div>
          </div>
          <div class="card" id="network-briefing" style="margin-bottom:16px; border-left: 4px solid var(--accent-strong); font-size:13px; color:var(--text);">
            <div class="section-title">Network Briefing</div>
            <div id="network-briefing-text" style="color:var(--muted); line-height:1.5;">Awaiting data...</div>
          </div>
          <div class="grid two">
            <div class="card">
              <div class="section-title">Network Map</div>
              <div id="map-network" class="map"></div>
            </div>
            <div class="card">
              <div class="section-title">Top Series</div>
              <div id="network-list" class="list"></div>
            </div>
          </div>
          <div class="grid" style="margin-top:16px; gap:16px;">
            <div class="card">
              <div class="section-title">How to Read the Network</div>
              <div style="font-size:13px; color:var(--muted); line-height:1.5;">
                <p><strong>Nodes</strong> are incidents. <strong>Edges</strong> connect pairs within 0.5 miles and 3 days for the selected crime type. Components = potential series.</p>
                <p><strong>When to act:</strong> Large components (biggest series) indicate an active pattern; target those geographies/time windows first. High edges-to-nodes suggest tight clustering. Many small components = dispersed small series; monitor for growth.</p>
                <p><strong>Cross-check:</strong> If the largest component overlaps hotspots, prioritize deployment there. Low arrest rate + large component = enforcement gap.</p>
              </div>
            </div>
            <div class="card">
              <div class="section-title">Methodology (Network & Hotspots)</div>
              <div style="font-size:13px; color:var(--muted); line-height:1.5;">
                <p><strong>Hotspots:</strong> Haversine DBSCAN (eps≈0.2 miles, min_samples=5) on lat/long with sampling cap for performance. Radius shown is an approximate spread of the cluster.</p>
                <p><strong>Network:</strong> Incidents linked if within 0.5 miles and 3 days. We keep up to 20k most recent incidents per crime type; show up to the 10 largest components.</p>
                <p><strong>Scope:</strong> Defaults to API pull (Socrata crimes) limited by env vars (API_LIMIT, API_YEARS_BACK). Data quality depends on source timestamps/coords.</p>
              </div>
            </div>
            <div class="card">
              <div class="section-title">About the Data</div>
              <div style="font-size:13px; color:var(--muted); line-height:1.5;">
                <p>Source: Chicago crimes dataset (API or local CSV). Fields include incident date/time (local), location (masked block, lat/long), primary type, arrest/domestic flags, and police geography.</p>
                <p>Assumptions: Timestamps parsed in local time; booleans normalized; rows missing date/coords dropped. Hotspots and networks use coordinates as provided; Blocks are coarse for privacy.</p>
                <p>Limitations: API throttling or env limits may restrict history; if <span style="color:var(--warn);">records are low</span>, check DATA_SOURCE, API credentials, and year/limit settings.</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const TILE_URL = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const MAP_OPTS = { maxZoom: 18, attribution: "© OpenStreetMap" };

    let mapHotspots, mapNetwork, hourlyChart, monthlyChart;
    let hotspotLayer, networkLayer;

    document.addEventListener("DOMContentLoaded", async () => {
      mapHotspots = L.map("map-hotspots").setView([41.8781, -87.6298], 11);
      L.tileLayer(TILE_URL, MAP_OPTS).addTo(mapHotspots);

      mapNetwork = L.map("map-network").setView([41.8781, -87.6298], 11);
      L.tileLayer(TILE_URL, MAP_OPTS).addTo(mapNetwork);

      await loadSummary();
      await loadHotspots();
    });

    function setStatus(message, tone = "warn") {
      const banner = document.getElementById("status-banner");
      const text = document.getElementById("status-text");
      if (!message) {
        banner.style.display = "none";
        text.innerText = "";
        return;
      }
      const colors = { warn: "var(--warn)", danger: "var(--danger)", info: "var(--accent)" };
      banner.style.display = "block";
      banner.firstElementChild.style.borderLeftColor = colors[tone] || "var(--warn)";
      text.innerText = message;
    }

    async function loadSummary() {
      try {
        const res = await fetch("/api/summary");
        if (!res.ok) throw new Error("Summary fetch failed");
        const data = await res.json();
        lastSummary = data;
        if (!data.total_incidents || data.total_incidents === 0) {
          setStatus("No data loaded. Check DATA_SOURCE, CRIME_CSV_PATH, or API credentials.", "warn");
        } else {
          setStatus(null);
        }

        document.getElementById("kpi-total").innerText = data.total_incidents.toLocaleString();
        document.getElementById("kpi-arrest").innerText = (data.arrest_rate * 100).toFixed(1) + "%";
        document.getElementById("kpi-range").innerText = `${data.date_range.start} → ${data.date_range.end}`;
        const pareto = data.pareto_concentration || {};
        document.getElementById("pareto").innerText = pareto.top_20_percent_holds
          ? `Top 20% of beats hold ${pareto.top_20_percent_holds}% of crime. Beats covering 50%: ${pareto.beats_for_50_percent}% (${pareto.total_active_beats} active beats).`
          : "Not enough data to compute.";

        // Top types list
        const topTypesEl = document.getElementById("top-types");
        topTypesEl.innerHTML = "";
        const topTypes = Object.entries(data.top_types || {});
        const maxCount = Math.max(...topTypes.map(([, v]) => v), 1);
        topTypes.forEach(([name, count]) => {
          const row = document.createElement("div");
          row.className = "top-type-row";
          const left = document.createElement("div");
          left.style.flex = "1";
          left.innerHTML = `<span style="color:var(--text); font-weight:700;">${name}</span><div class="bar"><div style="width:${(count / maxCount) * 100}%;"></div></div>`;
          const right = document.createElement("div");
          right.style.color = "var(--muted)";
          right.style.fontWeight = "700";
          right.innerText = count.toLocaleString();
          row.append(left, right);
          topTypesEl.appendChild(row);
        });

        const labels = Object.keys(data.hourly_counts).map(h => `${h}:00`);
        const values = Object.values(data.hourly_counts);
        if (hourlyChart) hourlyChart.destroy();
        hourlyChart = new Chart(document.getElementById("chart-hourly"), {
          type: "bar",
          data: { labels, datasets: [{ label: "Incidents", data: values, backgroundColor: "#3b82f6", borderRadius: 4 }] },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: "#94a3b8" }, grid: { display: false } },
              y: { ticks: { color: "#94a3b8" }, grid: { color: "#1f2937" } }
            }
          }
        });

        // Monthly trend (last 12 months)
        const mLabels = Object.keys(data.monthly_counts || {}).sort();
        const mValues = mLabels.map(k => data.monthly_counts[k]);
        if (monthlyChart) monthlyChart.destroy();
        monthlyChart = new Chart(document.getElementById("chart-monthly"), {
          type: "line",
          data: { labels: mLabels, datasets: [{ label: "Incidents", data: mValues, fill: true, borderColor: "#60a5fa", backgroundColor: "rgba(96,165,250,0.25)", tension: 0.3, pointRadius: 0 }] },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: "#94a3b8", maxRotation: 0, minRotation: 0 }, grid: { display: false } },
              y: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.2)" } }
            }
          }
        });
        renderBriefing();
      } catch (err) {
        console.error(err);
        setStatus("Summary unavailable. Verify backend health and data load.", "danger");
      }
    }

    async function loadHotspots() {
      const type = document.getElementById("crime-select").value;
      const res = await fetch(`/api/hotspots?crime_type=${encodeURIComponent(type)}`);
      if (!res.ok) {
        setStatus("Hotspots unavailable. Verify backend and data load.", "danger");
        return;
      }
      const data = await res.json();

      document.getElementById("kpi-hotspots").innerText = data.length;
      if (hotspotLayer) hotspotLayer.remove();
      hotspotLayer = L.layerGroup();

      data.forEach(h => {
        const color = h.count > 100 ? "#ef4444" : h.count > 20 ? "#f59e0b" : "#3b82f6";
        L.circle([h.center_lat, h.center_lon], { radius: h.radius_approx_ft / 3.28, color, fillColor: color, fillOpacity: 0.4 })
          .bindPopup(`<strong>${h.count} events</strong><br>${h.crime_type}`)
          .addTo(hotspotLayer);
      });
      hotspotLayer.addTo(mapHotspots);

      // Refresh ops briefing using latest summary + hotspots count
      renderBriefing();
    }

    async function loadNetwork() {
      const type = document.getElementById("crime-select").value;
      const list = document.getElementById("network-list");
      list.innerHTML = "<div style='color:var(--muted);'>Running analysis...</div>";

      const res = await fetch(`/api/network?crime_type=${encodeURIComponent(type)}`);
      if (!res.ok) {
        list.innerHTML = "<div style='color:var(--danger);'>Network unavailable.</div>";
        setStatus("Network analysis unavailable. Verify backend and data load.", "warn");
        return;
      }
      const data = await res.json();

      document.getElementById("net-nodes").innerText = `Nodes: ${data.summary.connected_nodes ?? 0}`;
      document.getElementById("net-edges").innerText = `Edges: ${data.summary.edge_count ?? 0}`;
      document.getElementById("net-components").innerText = `Components: ${data.summary.components_count ?? 0}`;
      renderNetworkBriefing(type, data.summary);

      if (networkLayer) networkLayer.remove();
      networkLayer = L.layerGroup();

      const nodes = {};
      data.nodes.forEach(n => { nodes[n.id] = n; });
      data.edges.forEach(e => {
        const a = nodes[e.source]; const b = nodes[e.target];
        if (a && b) {
          L.polyline([[a.lat, a.lng], [b.lat, b.lng]], { color: "#3b82f6", weight: 1, opacity: 0.5 }).addTo(networkLayer);
        }
      });
      data.nodes.forEach(n => {
        L.circleMarker([n.lat, n.lng], { radius: 4, color: "#fff", fillColor: "#ef4444", fillOpacity: 0.85, weight: 1 })
          .bindPopup(`<strong>${n.date}</strong><br>${n.desc || ""}`)
          .addTo(networkLayer);
      });
      networkLayer.addTo(mapNetwork);

      list.innerHTML = "";
      if (!data.summary.components_count) {
        list.innerHTML = "<div style='color:var(--muted);'>No connected series found.</div>";
        return;
      }
      const item = document.createElement("div");
      item.className = "pill";
      item.innerText = `Largest series size: ${data.summary.largest_component_size} events`;
      list.appendChild(item);
    }

    function setView(view) {
      document.getElementById("view-dashboard").style.display = view === "dashboard" ? "block" : "none";
      document.getElementById("view-network").style.display = view === "network" ? "block" : "none";
      document.getElementById("btn-dashboard").classList.toggle("active", view === "dashboard");
      document.getElementById("btn-network").classList.toggle("active", view === "network");
      setTimeout(() => {
        mapHotspots.invalidateSize();
        mapNetwork.invalidateSize();
      }, 200);
      if (view === "network") {
        loadNetwork();
      }
    }

    function refreshView() {
      loadHotspots();
      if (document.getElementById("view-network").style.display !== "none") {
        loadNetwork();
      }
    }

    // --- Briefings ---
    let lastSummary = null;
    function renderBriefing() {
      if (!lastSummary) return;
      const span = `${lastSummary.date_range.start} → ${lastSummary.date_range.end}`;
      const arrest = (lastSummary.arrest_rate * 100).toFixed(1);
      const pareto = lastSummary.pareto_concentration || {};
      const conc = pareto.top_20_percent_holds
        ? `Top 20% of beats hold ${pareto.top_20_percent_holds}% of incidents; ${pareto.beats_for_50_percent}% of beats cover 50% of incidents.`
        : "Concentration metrics not available.";
      const topTypes = Object.entries(lastSummary.top_types || {}).slice(0, 4).map(([k, v]) => `${k} (${v.toLocaleString()})`).join(", ");
      const hotspots = document.getElementById("kpi-hotspots").innerText || "--";
      const text = `Ops snapshot: ${lastSummary.total_incidents.toLocaleString()} incidents (${span}); arrest rate ${arrest}%. ${conc} Top categories: ${topTypes || "n/a"}. Active hotspots: ${hotspots}. Focus deployments where hotspots overlap high-concentration beats.`;

      let briefingCard = document.getElementById("status-briefing-card");
      if (!briefingCard) {
        const section = document.querySelector("#view-dashboard .cards");
        const card = document.createElement("div");
        card.className = "card";
        card.id = "status-briefing-card";
        card.innerHTML = `<div class="kpi-label">Ops Briefing</div><div id="briefing-text" style="margin-top:8px; line-height:1.5; color:var(--muted); font-size:13px;"></div>`;
        section.appendChild(card);
      }
      const textNode = document.getElementById("briefing-text");
      if (textNode) textNode.innerText = text;
    }

    function renderNetworkBriefing(crimeType, summary) {
      const nodes = summary.connected_nodes ?? 0;
      const edges = summary.edge_count ?? 0;
      const comps = summary.components_count ?? 0;
      const largest = summary.largest_component_size ?? 0;
      const msg = comps
        ? `${crimeType}: ${comps} series detected; largest links ${largest} incidents. ${nodes} linked incidents via ${edges} edges. Prioritize the largest series geography/time window for disruption; compare against hotspots for deployment.`
        : `${crimeType}: no connected series detected. Monitor for emerging clusters.`;
      const el = document.getElementById("network-briefing-text");
      if (el) el.innerText = msg;
    }
  </script>
</body>
</html>
